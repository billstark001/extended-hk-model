<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homophily-Polarization Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.0.3/dist/svg2pdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        label {
            display: inline-block;
            width: 80px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 150px;
            margin: 0 5px;
        }
        input[type="number"] {
            width: 60px;
            margin: 0 3px;
            padding: 2px;
        }
        .value-display {
            font-family: monospace;
            color: #666;
        }
        .io-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .io-controls button {
            margin: 5px;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .io-controls button:hover {
            background-color: #0056b3;
        }
        .export-button {
            background-color: #28a745 !important;
        }
        .export-button:hover {
            background-color: #218838 !important;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .tangent-controls {
            margin-left: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Ip-Ih Phase Diagram</h2>
        
        <div class="controls">
            <h3>Point Positions & Tangent Controls</h3>
            
            <div class="control-group">
                <label>Point 1:</label>
                <input type="range" id="p1x" min="0" max="100" value="10">
                <input type="range" id="p1y" min="0" max="100" value="10">
                <span class="value-display" id="p1-display">(10, 10)</span>
            </div>
            
            <div class="control-group">
                <label>Point 2:</label>
                <input type="range" id="p2x" min="0" max="100" value="30">
                <input type="range" id="p2y" min="0" max="100" value="65">
                <span class="value-display" id="p2-display">(30, 65)</span>
                <div class="tangent-controls">
                    <label>1→2出:</label> 角度:<input type="number" id="t12out-angle" value="80" min="-360" max="360"> 长度:<input type="number" id="t12out-length" value="80" min="10" max="200"><br>
                    <label>1→2入:</label> 角度:<input type="number" id="t12in-angle" value="220" min="-360" max="360"> 长度:<input type="number" id="t12in-length" value="60" min="10" max="200">
                </div>
            </div>
            
            <div class="control-group">
                <label>Point 3:</label>
                <input type="range" id="p3x" min="0" max="100" value="60">
                <input type="range" id="p3y" min="0" max="100" value="26">
                <span class="value-display" id="p3-display">(60, 26)</span>
                <div class="tangent-controls">
                    <label>1→3出:</label> 角度:<input type="number" id="t13out-angle" value="0" min="-360" max="360"> 长度:<input type="number" id="t13out-length" value="120" min="10" max="200"><br>
                    <label>1→3入:</label> 角度:<input type="number" id="t13in-angle" value="210" min="-360" max="360"> 长度:<input type="number" id="t13in-length" value="80" min="10" max="200">
                </div>
            </div>
            
            <div class="control-group">
                <label>Point 4:</label>
                <input type="range" id="p4x" min="0" max="100" value="53">
                <input type="range" id="p4y" min="0" max="100" value="75">
                <span class="value-display" id="p4-display">(53, 75)</span>
                <div class="tangent-controls">
                    <label>2→4出:</label> 角度:<input type="number" id="t24out-angle" value="35" min="-360" max="360"> 长度:<input type="number" id="t24out-length" value="40" min="10" max="200"><br>
                    <label>2→4入:</label> 角度:<input type="number" id="t24in-angle" value="180" min="-360" max="360"> 长度:<input type="number" id="t24in-length" value="40" min="10" max="200"><br>
                    <label>3→4出:</label> 角度:<input type="number" id="t34out-angle" value="50" min="-360" max="360"> 长度:<input type="number" id="t34out-length" value="80" min="10" max="200"><br>
                    <label>3→4入:</label> 角度:<input type="number" id="t34in-angle" value="-20" min="-360" max="360"> 长度:<input type="number" id="t34in-length" value="50" min="10" max="200">
                </div>
            </div>
            
            <div class="control-group">
                <label>Point 5:</label>
                <input type="range" id="p5x" min="0" max="100" value="85">
                <input type="range" id="p5y" min="0" max="100" value="75">
                <span class="value-display" id="p5-display">(85, 75)</span>
                <div class="tangent-controls">
                    <label>4→5出:</label> 角度:<input type="number" id="t45out-angle" value="0" min="-360" max="360"> 长度:<input type="number" id="t45out-length" value="40" min="10" max="200"><br>
                    <label>4→5入:</label> 角度:<input type="number" id="t45in-angle" value="180" min="-360" max="360"> 长度:<input type="number" id="t45in-length" value="40" min="10" max="200"><br>
                    <label>3→5出:</label> 角度:<input type="number" id="t35out-angle" value="40" min="-360" max="360"> 长度:<input type="number" id="t35out-length" value="70" min="10" max="200"><br>
                    <label>3→5入:</label> 角度:<input type="number" id="t35in-angle" value="260" min="-360" max="360"> 长度:<input type="number" id="t35in-length" value="60" min="10" max="200"><br>
                    <label>2→5出:</label> 角度:<input type="number" id="t25out-angle" value="15" min="-360" max="360"> 长度:<input type="number" id="t25out-length" value="120" min="10" max="200"><br>
                    <label>2→5入:</label> 角度:<input type="number" id="t25in-angle" value="185" min="-360" max="360"> 长度:<input type="number" id="t25in-length" value="100" min="10" max="200">
                </div>
            </div>
        </div>

        <div class="io-controls">
            <h3>Configuration Import/Export</h3>
            <button onclick="exportConfig()">Export Configuration</button>
            <button onclick="importConfig()">Import Configuration</button>
            <button onclick="resetConfig()">Reset to Default</button>
            <button onclick="exportToPDF()" class="export-button">Export to PDF</button>
            <button onclick="exportToSVG()" class="export-button">Export to SVG</button>
            <button onclick="exportMultiple()" class="export-button">Export Both</button>
            <textarea id="configTextarea" placeholder="Configuration JSON will appear here..."></textarea>
        </div>

        <svg id="mainSVG" width="600" height="450" viewBox="0 0 600 450">
            <!-- 定义斜线纹路图案 -->
            <defs>
                <!-- 红色斜线纹路 -->
                <pattern id="redDiagonalHatch" patternUnits="userSpaceOnUse" width="8" height="8">
                    <rect width="8" height="8" fill="#ffcccc"/>
                    <path d="M-2,2 l4,-4 M0,8 l8,-8 M6,10 l4,-4" stroke="#cc6666" stroke-width="1"/>
                </pattern>
                
                <!-- 蓝色斜线纹路 -->
                <pattern id="blueDiagonalHatch" patternUnits="userSpaceOnUse" width="8" height="8">
                    <rect width="8" height="8" fill="#ccddff"/>
                    <path d="M-2,6 l4,4 M0,0 l8,8 M6,-2 l4,4" stroke="#6699cc" stroke-width="1"/>
                </pattern>

                <!-- 箭头标记 -->
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                </marker>
            </defs>

            <!-- 坐标轴 -->
            <line x1="50" y1="400" x2="550" y2="400" stroke="#333" stroke-width="2"/>
            <line x1="50" y1="400" x2="50" y2="50" stroke="#333" stroke-width="2"/>
            
            <!-- 坐标轴箭头 -->
            <polygon points="550,400 545,395 545,405" fill="#333"/>
            <polygon points="50,50 45,55 55,55" fill="#333"/>

            <!-- 阴影区域 (红色在下层，蓝色在上层) -->
            <path id="redArea" fill="url(#redDiagonalHatch)" stroke="none" opacity="0.6"/>
            <path id="blueArea" fill="url(#blueDiagonalHatch)" stroke="none" opacity="0.6"/>

            <!-- 实线箭头 -->
            <path id="arrow13" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <path id="arrow35" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- 虚线箭头 -->
            <path id="arrow34" fill="none" stroke="#333" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
            <path id="arrow25" fill="none" stroke="#333" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>

            <!-- 纯箭头（无线条） -->
            <path id="arrow12" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <path id="arrow24" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <path id="arrow45" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- 点的垂直虚线 -->
            <line id="vline1" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="hline1" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="vline2" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="hline2" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="vline3" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="hline3" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="vline4" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="hline4" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="vline5" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>
            <line id="hline5" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>

            <!-- 点 -->
            <circle id="point1" r="6" fill="#8B4513"/>
            <circle id="point2" r="6" fill="#8B4513"/>
            <circle id="point3" r="6" fill="#8B4513"/>
            <circle id="point4" r="6" fill="#8B4513"/>
            <circle id="point5" r="6" fill="#8B4513"/>

            <!-- 点的标签 -->
            <text id="label1" font-size="18" font-weight="bold" fill="#333">1</text>
            <text id="label2" font-size="18" font-weight="bold" fill="#333">2</text>
            <text id="label3" font-size="18" font-weight="bold" fill="#333">3</text>
            <text id="label4" font-size="18" font-weight="bold" fill="#333">4</text>
            <text id="label5" font-size="18" font-weight="bold" fill="#333">5</text>

            <!-- 坐标轴标签 -->
            <text x="560" y="405" text-anchor="middle" font-size="16" font-weight="bold">
                I<tspan baseline-shift="sub">p</tspan>
            </text>
            <text x="40" y="40" text-anchor="middle" font-size="16" font-weight="bold">
                I<tspan baseline-shift="sub">h</tspan>
            </text>

            <!-- 动态标签 -->
            <text id="labelInitialX" text-anchor="middle" font-size="18" fill="#333">random</text>
            <text id="labelInitialY" text-anchor="middle" font-size="18" fill="#333">rand.</text>
            <text id="labelConsensual" text-anchor="middle" font-size="18" fill="#333">consensual</text>
            <text id="labelFinal" text-anchor="middle" font-size="18" fill="#333">max.</text>
            <text id="labelSegregated" text-anchor="middle" font-size="18" fill="#333">segregated</text>
        </svg>
    </div>

    <script src="./scripts/default-config.js"></script>
    <script src="./scripts/export-utils.js"></script>
    <script>
        // 使用您提供的默认配置
        let config = getDefaultConfig();

        // 转换坐标系
        function transform(x, y) {
            return {
                x: 50 + (x / 100) * 480,
                y: 400 - (y / 100) * 350
            };
        }

        // 计算贝塞尔控制点
        function getBezierControlPoint(point, angle, length) {
            const radians = (angle * Math.PI) / 180;
            return {
                x: point.x + Math.cos(radians) * length,
                y: point.y - Math.sin(radians) * length
            };
        }

        // 生成贝塞尔曲线路径
        function generateBezierPath(p1, p2, tangent) {
            const t1 = transform(p1.x, p1.y);
            const t2 = transform(p2.x, p2.y);
            
            const cp1 = getBezierControlPoint(t1, tangent.out.angle, tangent.out.length);
            const cp2 = getBezierControlPoint(t2, tangent.in.angle, tangent.in.length);
            
            return `M ${t1.x},${t1.y} C ${cp1.x},${cp1.y} ${cp2.x},${cp2.y} ${t2.x},${t2.y}`;
        }

        // 生成红色区域路径（上边界经过点1-2-4-5，下边界是x轴）
        function generateRedAreaPath() {
            const t1 = transform(config.points[1].x, config.points[1].y);
            const t2 = transform(config.points[2].x, config.points[2].y);
            const t4 = transform(config.points[4].x, config.points[4].y);
            const t5 = transform(config.points[5].x, config.points[5].y);
            
            // 1->2的控制点
            const cp1_12 = getBezierControlPoint(t1, config.tangents['12'].out.angle, config.tangents['12'].out.length);
            const cp2_12 = getBezierControlPoint(t2, config.tangents['12'].in.angle, config.tangents['12'].in.length);
            
            // 2->4的控制点
            const cp1_24 = getBezierControlPoint(t2, config.tangents['24'].out.angle, config.tangents['24'].out.length);
            const cp2_24 = getBezierControlPoint(t4, config.tangents['24'].in.angle, config.tangents['24'].in.length);
            
            // 4->5的控制点
            const cp1_45 = getBezierControlPoint(t4, config.tangents['45'].out.angle, config.tangents['45'].out.length);
            const cp2_45 = getBezierControlPoint(t5, config.tangents['45'].in.angle, config.tangents['45'].in.length);
            
            return `M ${t1.x},400 
                    L ${t1.x},${t1.y} 
                    C ${cp1_12.x},${cp1_12.y} ${cp2_12.x},${cp2_12.y} ${t2.x},${t2.y}
                    C ${cp1_24.x},${cp1_24.y} ${cp2_24.x},${cp2_24.y} ${t4.x},${t4.y}
                    C ${cp1_45.x},${cp1_45.y} ${cp2_45.x},${cp2_45.y} ${t5.x},${t5.y}
                    L ${t5.x},400 Z`;
        }

        // 生成蓝色区域路径（上边界经过点1-3-5，下边界是x轴）
        function generateBlueAreaPath() {
            const t1 = transform(config.points[1].x, config.points[1].y);
            const t3 = transform(config.points[3].x, config.points[3].y);
            const t5 = transform(config.points[5].x, config.points[5].y);
            
            // 1->3的控制点
            const cp1_13 = getBezierControlPoint(t1, config.tangents['13'].out.angle, config.tangents['13'].out.length);
            const cp2_13 = getBezierControlPoint(t3, config.tangents['13'].in.angle, config.tangents['13'].in.length);
            
            // 3->5的控制点
            const cp1_35 = getBezierControlPoint(t3, config.tangents['35'].out.angle, config.tangents['35'].out.length);
            const cp2_35 = getBezierControlPoint(t5, config.tangents['35'].in.angle, config.tangents['35'].in.length);
            
            return `M ${t1.x},400 
                    L ${t1.x},${t1.y} 
                    C ${cp1_13.x},${cp1_13.y} ${cp2_13.x},${cp2_13.y} ${t3.x},${t3.y}
                    C ${cp1_35.x},${cp1_35.y} ${cp2_35.x},${cp2_35.y} ${t5.x},${t5.y}
                    L ${t5.x},400 Z`;
        }

        // 更新动态标签位置
        function updateLabels() {
            const t1 = transform(config.points[1].x, config.points[1].y);
            const t4 = transform(config.points[4].x, config.points[4].y);
            const t5 = transform(config.points[5].x, config.points[5].y);

            // 点1对应的initial标签
            document.getElementById('labelInitialX').setAttribute('x', t1.x);
            document.getElementById('labelInitialX').setAttribute('y', 415);
            
            document.getElementById('labelInitialY').setAttribute('x', 30);
            document.getElementById('labelInitialY').setAttribute('y', t1.y + 5);

            // 点4对应的consensual标签
            document.getElementById('labelConsensual').setAttribute('x', t4.x);
            document.getElementById('labelConsensual').setAttribute('y', 415);

            // 点5对应的final和segregated标签
            document.getElementById('labelFinal').setAttribute('x', 30);
            document.getElementById('labelFinal').setAttribute('y', t5.y + 5);
            
            document.getElementById('labelSegregated').setAttribute('x', t5.x - 10);
            document.getElementById('labelSegregated').setAttribute('y', 415);
        }

        // 更新图表
        function updateChart() {
            // 更新点位置
            for (let i = 1; i <= 5; i++) {
                const t = transform(config.points[i].x, config.points[i].y);
                document.getElementById(`point${i}`).setAttribute('cx', t.x);
                document.getElementById(`point${i}`).setAttribute('cy', t.y);
                document.getElementById(`label${i}`).setAttribute('x', t.x - 8);
                document.getElementById(`label${i}`).setAttribute('y', t.y - 12);
                
                // 更新垂直和水平线
                document.getElementById(`vline${i}`).setAttribute('x1', t.x);
                document.getElementById(`vline${i}`).setAttribute('y1', 50);
                document.getElementById(`vline${i}`).setAttribute('x2', t.x);
                document.getElementById(`vline${i}`).setAttribute('y2', 400);
                
                document.getElementById(`hline${i}`).setAttribute('x1', 50);
                document.getElementById(`hline${i}`).setAttribute('y1', t.y);
                document.getElementById(`hline${i}`).setAttribute('x2', 550);
                document.getElementById(`hline${i}`).setAttribute('y2', t.y);
            }

            // 更新箭头路径
            document.getElementById('arrow12').setAttribute('d', generateBezierPath(config.points[1], config.points[2], config.tangents['12']));
            document.getElementById('arrow13').setAttribute('d', generateBezierPath(config.points[1], config.points[3], config.tangents['13']));
            document.getElementById('arrow24').setAttribute('d', generateBezierPath(config.points[2], config.points[4], config.tangents['24']));
            document.getElementById('arrow34').setAttribute('d', generateBezierPath(config.points[3], config.points[4], config.tangents['34']));
            document.getElementById('arrow45').setAttribute('d', generateBezierPath(config.points[4], config.points[5], config.tangents['45']));
            document.getElementById('arrow35').setAttribute('d', generateBezierPath(config.points[3], config.points[5], config.tangents['35']));
            document.getElementById('arrow25').setAttribute('d', generateBezierPath(config.points[2], config.points[5], config.tangents['25']));

            // 更新阴影区域
            document.getElementById('redArea').setAttribute('d', generateRedAreaPath());
            document.getElementById('blueArea').setAttribute('d', generateBlueAreaPath());

            // 更新标签位置
            updateLabels();
        }

        // 更新UI显示
        function updateUI() {
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`p${i}x`).value = config.points[i].x;
                document.getElementById(`p${i}y`).value = config.points[i].y;
                document.getElementById(`p${i}-display`).textContent = `(${config.points[i].x}, ${config.points[i].y})`;
            }
            
            for (let connection in config.tangents) {
                const t = config.tangents[connection];
                document.getElementById(`t${connection}out-angle`).value = t.out.angle;
                document.getElementById(`t${connection}out-length`).value = t.out.length;
                document.getElementById(`t${connection}in-angle`).value = t.in.angle;
                document.getElementById(`t${connection}in-length`).value = t.in.length;
            }
        }

        // 添加事件监听器
        function setupEventListeners() {
            // 点位置监听器
            for (let i = 1; i <= 5; i++) {
                const xSlider = document.getElementById(`p${i}x`);
                const ySlider = document.getElementById(`p${i}y`);
                const display = document.getElementById(`p${i}-display`);

                function updatePoint() {
                    config.points[i].x = parseInt(xSlider.value);
                    config.points[i].y = parseInt(ySlider.value);
                    display.textContent = `(${config.points[i].x}, ${config.points[i].y})`;
                    updateChart();
                }

                xSlider.addEventListener('input', updatePoint);
                ySlider.addEventListener('input', updatePoint);
            }

            // 切线监听器
            for (let connection in config.tangents) {
                ['out-angle', 'out-length', 'in-angle', 'in-length'].forEach(prop => {
                    const element = document.getElementById(`t${connection}${prop}`);
                    if (element) {
                        element.addEventListener('input', function() {
                            const [dir, attr] = prop.split('-');
                            config.tangents[connection][dir][attr] = parseInt(this.value);
                            updateChart();
                        });
                    }
                });
            }
        }

        // 导出配置
        function exportConfig() {
            const configJson = JSON.stringify(config, null, 2);
            document.getElementById('configTextarea').value = configJson;
        }

        // 导入配置
        function importConfig() {
            try {
                const configText = document.getElementById('configTextarea').value;
                const newConfig = JSON.parse(configText);
                config = newConfig;
                updateUI();
                updateChart();
                alert('Configuration imported successfully!');
            } catch (error) {
                alert('Error importing configuration: ' + error.message);
            }
        }

        // 重置配置
        function resetConfig() {
            config = getDefaultConfig();
            updateUI();
            updateChart();
        }

        // 导出为PDF
        async function exportToPDF() {
            await window.exportUtils.exportSVGToPDF('mainSVG', 'ip-ih-phase-diagram.pdf', {
                orientation: 'landscape',
                unit: 'pt',
                format: [600, 450]
            });
        }

        // 导出为SVG
        async function exportToSVG() {
            await window.exportUtils.exportToSVG('mainSVG', 'ip-ih-phase-diagram.svg');
        }

        // 导出多种格式
        async function exportMultiple() {
            await window.exportUtils.exportMultipleFormats('container', 'ip-ih-phase-diagram', ['pdf', 'svg'], {
                pdf: { orientation: 'landscape', format: 'a4' },
                svg: {}
            });
        }

        // 初始化
        setupEventListeners();
        updateUI();
        updateChart();
    </script>
</body>
</html>